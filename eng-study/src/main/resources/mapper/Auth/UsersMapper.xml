<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eng.study.engstudy.mapper.UsersMapper">

    <!-- ResultMap: users 테이블과 UsersVO 매핑 -->
    <resultMap id="UsersResultMap" type="com.eng.study.engstudy.model.vo.UsersVO">
        <id     property="usersId"          column="users_id"/>
        <result property="loginId"          column="login_id"/>
        <result property="email"            column="email"/>
        <result property="password"         column="password"/>
        <result property="fullName"         column="full_name"/>
        <!-- 주소 정보 -->
        <result property="postalCode"       column="postal_code"/>
        <result property="address"          column="address"/>
        <result property="addressDetail"    column="address_detail"/>
        <result property="addressType"      column="address_type"/>
        <result property="sido"             column="sido"/>
        <result property="sigungu"          column="sigungu"/>
        <result property="bname"            column="bname"/>
        <!-- 계정 정보 -->
        <result property="lastLogin"        column="last_login"/>
        <result property="isActive"         column="is_active"/>
        <result property="role"             column="role"/>
        <!-- 시스템 필드 -->
        <result property="createdAt"        column="created_at"/>
        <result property="createdId"        column="created_id"/>
        <result property="updatedAt"        column="updated_at"/>
        <result property="updatedId"        column="updated_id"/>
    </resultMap>

    <!--
        회원가입: 사용자 등록
        - users_id: BIGSERIAL (자동 생성)
        - is_active: DEFAULT TRUE
        - role: DEFAULT 'USER'
        - created_at: DEFAULT CURRENT_TIMESTAMP
        - updated_at: DEFAULT CURRENT_TIMESTAMP
    -->
    <insert id="insertUser" parameterType="com.eng.study.engstudy.model.vo.UsersVO"
            useGeneratedKeys="true" keyProperty="usersId">
        INSERT INTO users (
            login_id,
            email,
            password,
            full_name,
            postal_code,
            address,
            address_detail,
            address_type,
            sido,
            sigungu,
            bname,
            is_active,
            role,
            created_id
        ) VALUES (
                     #{loginId},
                     #{email},
                     #{password},
                     #{fullName},
                     #{postalCode},
                     #{address},
                     #{addressDetail},
                     #{addressType},
                     #{sido},
                     #{sigungu},
                     #{bname},
                     COALESCE(#{isActive}, TRUE),
                     COALESCE(#{role}, 'USER'),
                     #{createdId}
                 )
    </insert>

    <!-- 로그인 ID로 사용자 조회 -->
    <select id="findByLoginId" resultMap="UsersResultMap">
        SELECT
            users_id,
            login_id,
            email,
            password,
            full_name,
            postal_code,
            address,
            address_detail,
            address_type,
            sido,
            sigungu,
            bname,
            last_login,
            is_active,
            role,
            created_at,
            created_id,
            updated_at,
            updated_id
        FROM users
        WHERE login_id = #{loginId}
    </select>

    <!-- 이메일로 사용자 조회 -->
    <select id="findByEmail" resultMap="UsersResultMap">
        SELECT
            users_id,
            login_id,
            email,
            password,
            full_name,
            postal_code,
            address,
            address_detail,
            address_type,
            sido,
            sigungu,
            bname,
            last_login,
            is_active,
            role,
            created_at,
            created_id,
            updated_at,
            updated_id
        FROM users
        WHERE email = #{email}
    </select>

    <!-- 사용자 ID로 사용자 조회 -->
    <select id="findByUsersId" resultMap="UsersResultMap">
        SELECT
            users_id,
            login_id,
            email,
            password,
            full_name,
            postal_code,
            address,
            address_detail,
            address_type,
            sido,
            sigungu,
            bname,
            last_login,
            is_active,
            role,
            created_at,
            created_id,
            updated_at,
            updated_id
        FROM users
        WHERE users_id = #{usersId}
    </select>

    <!-- 로그인 ID 중복 확인 -->
    <select id="countByLoginId" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE login_id = #{loginId}
    </select>

    <!-- 이메일 중복 확인 -->
    <select id="countByEmail" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE email = #{email}
    </select>

</mapper>