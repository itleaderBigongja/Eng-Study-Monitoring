# Elasticsearch 인덱스 정의
input {
  # 1. Application Log
  file {
    path => "/usr/share/logstash/pipeline/logs/application.log"
    start_position => "beginning"
    codec => json
    tags => ["app_log"]
  }

  # 2. Error Log
  file {
    path => "/usr/share/logstash/pipeline/logs/error.log"
    start_position => "beginning"
    codec => json
    tags => ["error_log"]
  }

  # 3. Access Log
  file {
    path => "/usr/share/logstash/pipeline/logs/access.log"
    start_position => "beginning"
    codec => json
    tags => ["access_log"]
  }

  # 4. Audit Log
  file {
    path => "/usr/share/logstash/pipeline/logs/audit.log"
    start_position => "beginning"
    codec => json
    tags => ["audit_log"]
  }

  # 5. Database Log
  file {
    path => "/usr/share/logstash/pipeline/logs/database.log"
    start_position => "beginning"
    codec => json
    tags => ["db_log"]
  }

  # 6. Security Log
  file {
    path => "/usr/share/logstash/pipeline/logs/security.log"
    start_position => "beginning"
    codec => json
    tags => ["sec_log"]
  }

  # 7. Performance Log
  file {
    path => "/usr/share/logstash/pipeline/logs/performance.log"
    start_position => "beginning"
    codec => json
    tags => ["perf_log"]
  }
}

filter {
  # 1. 타임스탬프 처리
  date {
    match => [
      "@timestamp",
      "ISO8601",
      "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSZ",
      "yyyy-MM-dd'T'HH:mm:ssZ",
      "yyyy-MM-dd HH:mm:ss.SSS",
      "yyyy-MM-dd HH:mm:ss"
    ]
    target => "@timestamp"
    timezone => "Asia/Seoul"
  }

  # ==========================================
  # 2. Security Log - 완전 재구성
  # ==========================================
  if "sec_log" in [tags] {
    if [logger] { mutate { copy => { "logger" => "logger_name" } } }
    if [level] { mutate { copy => { "level" => "log_level" } } }

    # ✅ 1. 기본 필드 생성 (모든 로그에 적용)
    mutate {
      add_field => {
        "[security][threat_level]" => "low"
        "[security][event_type]" => "info"
        "security_type" => "General Event"
      }
    }

    # ✅ 2. MDC 필드가 있으면 nested object로 재구성 (WAF 등)
    if [attack_type] {
      mutate {
        add_field => { "[attack][type]" => "%{attack_type}" }
        remove_field => [ "attack_type" ]
      }
    }

    if [threat_level] {
      mutate {
        replace => { "[security][threat_level]" => "%{threat_level}" }
        remove_field => [ "threat_level" ]
      }
    }

    if [source_ip] {
      mutate {
        add_field => { "[client][ip]" => "%{source_ip}" }
        remove_field => [ "source_ip" ]
      }
    }

    # blocked 필드 boolean 변환
    if [blocked] {
      if [blocked] == "true" {
        mutate { replace => { "blocked" => true } }
      } else {
        mutate { replace => { "blocked" => false } }
      }
    } else {
      # blocked 필드가 없으면 기본값 false
      mutate { add_field => { "blocked" => false } }
    }

    # ✅ 3. message 기반 분석 (Spring Security 텍스트 로그)
    if [message] {
      if [message] =~ /Bad credentials|password does not match|User not found|Authentication failed/ {
        mutate {
          replace => {
            "log_level" => "WARN"
            "security_type" => "Login Failure"
            "[security][threat_level]" => "medium"
            "[security][event_type]" => "authentication_failure"
          }
        }
        # attack 객체 생성
        if ![attack][type] {
          mutate {
            add_field => { "[attack][type]" => "login_failure" }
          }
        }
      } else if [message] =~ /Access is denied|AccessDeniedException|AnonymousAuthenticationToken/ {
        mutate {
          replace => {
            "log_level" => "ERROR"
            "security_type" => "Access Denied"
            "[security][threat_level]" => "high"
            "[security][event_type]" => "authorization_failure"
          }
        }
        if ![attack][type] {
          mutate {
            add_field => { "[attack][type]" => "access_denied" }
          }
        }
      } else if [message] =~ /Invalid CSRF|Missing CSRF/ {
        mutate {
          replace => {
            "log_level" => "ERROR"
            "security_type" => "CSRF Warning"
            "[security][threat_level]" => "critical"
            "[security][event_type]" => "csrf_attack"
          }
        }
        if ![attack][type] {
          mutate {
            add_field => { "[attack][type]" => "csrf" }
          }
        }
      } else if [message] =~ /Session.*expired/ {
        mutate {
          replace => {
            "log_level" => "WARN"
            "security_type" => "Session Expired"
            "[security][threat_level]" => "low"
            "[security][event_type]" => "session_expired"
          }
        }
        if ![attack][type] {
          mutate {
            add_field => { "[attack][type]" => "session_expired" }
          }
        }
      }
    }
  }

  # ==========================================
  # 3. Database Log - 완전 재구성
  # ==========================================
  if "db_log" in [tags] {
    if [logger] { mutate { copy => { "logger" => "logger_name" } } }
    if [level] { mutate { copy => { "level" => "log_level" } } }

    # ✅ MDC 필드를 nested object로 재구성
    if [duration_ms] {
      # query.duration_ms 생성 (숫자 타입)
      mutate {
        add_field => { "[query][duration_ms]" => "%{duration_ms}" }
        remove_field => [ "duration_ms" ]
      }
      # 숫자로 변환
      mutate {
        convert => { "[query][duration_ms]" => "integer" }
      }
    }

    if [sql_id] {
      mutate {
        add_field => { "[query][sql_id]" => "%{sql_id}" }
        remove_field => [ "sql_id" ]
      }
    }

    # table 필드는 그대로 유지 (최상위)

    # operation 필드 그대로 유지 (최상위)

    # ERROR 레벨인 경우 db_error 태그 추가
    if [log_level] == "ERROR" {
      mutate { add_tag => [ "db_error", "error_log" ] }
    }
  }

  # ==========================================
  # 4. Audit Log - event 객체 생성
  # ==========================================
  if "audit_log" in [tags] {
    # ✅ 1. 무조건 event 객체 생성 (기본값)
    mutate {
      add_field => {
        "[event][action]" => "general"
        "[event][category]" => "general"
        "[event][result]" => "success"
      }
    }

    # ✅ 2. message 기반 분류 (덮어쓰기)
    if [message] =~ /registration/ {
      mutate {
        replace => {
          "[event][action]" => "user.registration"
          "[event][category]" => "authentication"
        }
      }
    } else if [message] =~ /login.*success|successfully logged in/ {
      mutate {
        replace => {
          "[event][action]" => "user.login"
          "[event][category]" => "authentication"
        }
      }
    } else if [message] =~ /login.*fail|authentication failed/ {
      mutate {
        replace => {
          "[event][action]" => "user.login"
          "[event][category]" => "authentication"
          "[event][result]" => "failure"
        }
      }
    } else if [message] =~ /logout/ {
      mutate {
        replace => {
          "[event][action]" => "user.logout"
          "[event][category]" => "authentication"
        }
      }
    }
  }

  # ==========================================
  # 5. Error Log 정규화
  # ==========================================
  if "error_log" in [tags] {
    if [source] and [source][class] {
      mutate { add_field => { "logger_name" => "%{[source][class]}" } }
    }
  }

  # ==========================================
  # 6. 불필요한 필드 제거
  # ==========================================
  mutate {
    remove_field => [ "log", "event.original", "host" ]
  }
}

output {
  # 1. DB 에러 처리 (가장 먼저 체크)
  if "db_error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "database-logs-%{+YYYY.MM.dd}"
    }
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  }
  # 2. 일반 DB 로그
  else if "db_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "database-logs-%{+YYYY.MM.dd}"
    }
  }
  # 3. 일반 에러 로그
  else if "error_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  }
  # 4. 애플리케이션 로그
  else if "app_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "application-logs-%{+YYYY.MM.dd}"
    }
  }
  # 5. 접근 로그
  else if "access_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "access-logs-%{+YYYY.MM.dd}"
    }
  }
  # 6. 보안 로그
  else if "sec_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "security-logs-%{+YYYY.MM.dd}"
    }
  }
  # 7. 감사 로그
  else if "audit_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "audit-logs-%{+YYYY.MM.dd}"
    }
  }
  # 8. 성능 로그
  else if "perf_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "performance-metrics-%{+YYYY.MM.dd}"
    }
  }

  # 디버깅용 (개발 중에만 활성화)
  stdout { codec => rubydebug }
}