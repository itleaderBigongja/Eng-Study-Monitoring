# Elasticsearch 인덱스 정의
input {
  # 1. Application Log
  file {
    path => "/usr/share/logstash/pipeline/logs/application.log"
    start_position => "beginning"
    codec => json
    tags => ["app_log"]
  }

  # 2. Error Log
  file {
    path => "/usr/share/logstash/pipeline/logs/error.log"
    start_position => "beginning"
    codec => json
    tags => ["error_log"]
  }

  # 3. Access Log
  file {
    path => "/usr/share/logstash/pipeline/logs/access.log"
    start_position => "beginning"
    codec => json
    tags => ["access_log"]
  }

  # 4. Audit Log
  file {
    path => "/usr/share/logstash/pipeline/logs/audit.log"
    start_position => "beginning"
    codec => json
    tags => ["audit_log"]
  }

  # 5. Database Log
  file {
    path => "/usr/share/logstash/pipeline/logs/database.log"
    start_position => "beginning"
    codec => json
    tags => ["db_log"]
  }

  # 6. Security Log
  file {
    path => "/usr/share/logstash/pipeline/logs/security.log"
    start_position => "beginning"
    codec => json
    tags => ["sec_log"]
  }

  # 7. Performance Log
  file {
    path => "/usr/share/logstash/pipeline/logs/performance.log"
    start_position => "beginning"
    codec => json
    tags => ["perf_log"]
  }
}

filter {
  # 1. 타임스탬프 처리
  date {
    match => [
      "@timestamp",
      "ISO8601",
      "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSZ",
      "yyyy-MM-dd'T'HH:mm:ssZ",
      "yyyy-MM-dd HH:mm:ss.SSS",
      "yyyy-MM-dd HH:mm:ss"
    ]
    target => "@timestamp"
    timezone => "Asia/Seoul"
  }

  # ==========================================
  # 2. Security Log - 완전 재구성
  # ==========================================
  if "sec_log" in [tags] {
    if [logger] { mutate { copy => { "logger" => "logger_name" } } }
    if [level] { mutate { copy => { "level" => "log_level" } } }

    # Ruby로 기본 필드 생성
    ruby {
      code => '
        event.set("[security][threat_level]", "low")
        event.set("[security][event_type]", "info")
        event.set("security_type", "General Event")
        event.set("blocked", false)
      '
    }

    # MDC 필드 재구성
    if [attack_type] {
      ruby {
        code => '
          event.set("[attack][type]", event.get("attack_type"))
        '
      }
      mutate { remove_field => [ "attack_type" ] }
    }

    if [threat_level] {
      ruby {
        code => '
          event.set("[security][threat_level]", event.get("threat_level"))
        '
      }
      mutate { remove_field => [ "threat_level" ] }
    }

    if [source_ip] {
      ruby {
        code => '
          event.set("[client][ip]", event.get("source_ip"))
        '
      }
      mutate { remove_field => [ "source_ip" ] }
    }

    # blocked 필드 boolean 변환
    if [blocked] {
      if [blocked] == "true" {
        mutate { replace => { "blocked" => true } }
      } else {
        mutate { replace => { "blocked" => false } }
      }
    }

    # message 기반 분석
    if [message] {
      if [message] =~ /Bad credentials|password does not match|User not found|Authentication failed/ {
        ruby {
          code => '
            event.set("log_level", "WARN")
            event.set("security_type", "Login Failure")
            event.set("[security][threat_level]", "medium")
            event.set("[security][event_type]", "authentication_failure")
            event.set("[attack][type]", "login_failure") unless event.get("[attack][type]")
          '
        }
      } else if [message] =~ /Access is denied|AccessDeniedException/ {
        ruby {
          code => '
            event.set("log_level", "ERROR")
            event.set("security_type", "Access Denied")
            event.set("[security][threat_level]", "high")
            event.set("[security][event_type]", "authorization_failure")
            event.set("[attack][type]", "access_denied") unless event.get("[attack][type]")
          '
        }
      } else if [message] =~ /Invalid CSRF|Missing CSRF/ {
        ruby {
          code => '
            event.set("log_level", "ERROR")
            event.set("security_type", "CSRF Warning")
            event.set("[security][threat_level]", "critical")
            event.set("[security][event_type]", "csrf_attack")
            event.set("[attack][type]", "csrf") unless event.get("[attack][type]")
          '
        }
      }
    }
  }

  # ==========================================
  # 3. Database Log - 완전 재구성
  # ==========================================
  if "db_log" in [tags] {
    if [logger] { mutate { copy => { "logger" => "logger_name" } } }
    if [level] { mutate { copy => { "level" => "log_level" } } }

    # MDC 필드를 nested object로 재구성
    if [duration_ms] {
      mutate {
          convert => { "duration_ms" => "integer" }
        }
      # query.duration_ms 생성 (숫자 타입)
      mutate {
        add_field => { "[query][duration_ms]" => "%{duration_ms}" }
        remove_field => [ "duration_ms" ]
      }
      # 숫자로 변환
      mutate {
        convert => { "[query][duration_ms]" => "integer" }
      }
    }

    if [sql_id] {
      mutate {
        add_field => { "[query][sql_id]" => "%{sql_id}" }
      }
    }
    if [log_level] == "ERROR" {
      mutate { add_tag => [ "db_error", "error_log" ] }
    }
  }

  # ==========================================
  # 4. Audit Log - event 객체 생성
  # ==========================================
  if "audit_log" in [tags] {
    # ✅ Ruby로 event 객체 강제 생성
    ruby {
      code => '
        event.set("[event][action]", "general")
        event.set("[event][category]", "general")
        event.set("[event][result]", "success")
      '
    }

    # ✅ message 기반 분류
    if [message] =~ /registration|registered/ {
      ruby {
        code => '
          event.set("[event][action]", "user.registration")
          event.set("[event][category]", "authentication")
        '
      }
    } else if [message] =~ /login.*success|successfully logged in/ {
      ruby {
        code => '
          event.set("[event][action]", "user.login")
          event.set("[event][category]", "authentication")
        '
      }
    } else if [message] =~ /login.*fail|authentication failed/ {
      ruby {
        code => '
          event.set("[event][action]", "user.login")
          event.set("[event][category]", "authentication")
          event.set("[event][result]", "failure")
        '
      }
    } else if [message] =~ /logout/ {
      ruby {
        code => '
          event.set("[event][action]", "user.logout")
          event.set("[event][category]", "authentication")
        '
      }
    }
  }

  # ==========================================
  # 5. Error Log 정규화
  # ==========================================
  if "error_log" in [tags] {
    if [source] and [source][class] {
      mutate { add_field => { "logger_name" => "%{[source][class]}" } }
    }
  }

  # ==========================================
  # 6. 불필요한 필드 제거
  # ==========================================
  mutate {
    remove_field => [ "log", "event.original", "host" ]
  }
}

output {
  # 1. DB 에러 처리 (가장 먼저 체크)
  if "db_error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "database-logs-%{+YYYY.MM.dd}"
    }
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  }
  # 2. 일반 DB 로그
  else if "db_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "database-logs-%{+YYYY.MM.dd}"
    }
  }
  # 3. 일반 에러 로그
  else if "error_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  }
  # 4. 애플리케이션 로그
  else if "app_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "application-logs-%{+YYYY.MM.dd}"
    }
  }
  # 5. 접근 로그
  else if "access_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "access-logs-%{+YYYY.MM.dd}"
    }
  }
  # 6. 보안 로그
  else if "sec_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "security-logs-%{+YYYY.MM.dd}"
    }
  }
  # 7. 감사 로그
  else if "audit_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "audit-logs-%{+YYYY.MM.dd}"
    }
  }
  # 8. 성능 로그
  else if "perf_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "performance-metrics-%{+YYYY.MM.dd}"
    }
  }

  # 디버깅용 (개발 중에만 활성화)
  stdout { codec => rubydebug }
}