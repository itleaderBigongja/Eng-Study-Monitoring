# Elasticsearch 인덱스 정의
input {
  # 1. Application Log
  file {
    path => "/usr/share/logstash/pipeline/logs/application.log"
    start_position => "beginning"
    codec => json
    tags => ["app_log"]
  }

  # 2. Error Log
  file {
    path => "/usr/share/logstash/pipeline/logs/error.log"
    start_position => "beginning"
    codec => json
    tags => ["error_log"]
  }

  # 3. Access Log
  file {
    path => "/usr/share/logstash/pipeline/logs/access.log"
    start_position => "beginning"
    codec => json
    tags => ["access_log"]
  }

  # 4. Audit Log
  file {
    path => "/usr/share/logstash/pipeline/logs/audit.log"
    start_position => "beginning"
    codec => json
    tags => ["audit_log"]
  }

  # 5. Database Log
  file {
    path => "/usr/share/logstash/pipeline/logs/database.log"
    start_position => "beginning"
    codec => json
    tags => ["db_log"]
  }

  # 6. Security Log
  file {
    path => "/usr/share/logstash/pipeline/logs/security.log"
    start_position => "beginning"
    codec => json
    tags => ["sec_log"]
  }

  # 7. Performance Log
  file {
    path => "/usr/share/logstash/pipeline/logs/performance.log"
    start_position => "beginning"
    codec => json
    tags => ["perf_log"]
  }
}

filter {
  # ======================================================
  # ✅ [핵심 추가] 모든 로그의 필드명 통일
  # ======================================================

  # 1. timestamp 처리
  date {
    match => [
      "@timestamp",
      "ISO8601",
      "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSSZ",
      "yyyy-MM-dd'T'HH:mm:ss.SSZ",
      "yyyy-MM-dd'T'HH:mm:ssZ",
      "yyyy-MM-dd HH:mm:ss.SSS",
      "yyyy-MM-dd HH:mm:ss"
    ]
    target => "@timestamp"
    timezone => "Asia/Seoul"
  }

  # ======================================================
  # ✅ [필드명 정규화] logLevel -> log_level 변환
  # ======================================================

  # 카멜케이스를 스네이크케이스로 통일
  if [logLevel] {
    mutate {
      rename => { "logLevel" => "log_level" }
    }
  }

  # level 필드도 log_level로 통일
  if [level] and ![log_level] {
    mutate {
      rename => { "level" => "log_level" }
    }
  }

  # ======================================================
    # ✅ [MDC Override] MDC에 정의된 log_level이 있다면 최우선 적용 (여기 추가!)
    # ======================================================
    if [mdc][log_level] {
      mutate {
        # 1. MDC의 값으로 log_level을 덮어씀 (예: ERROR -> CRITICAL)
        replace => { "log_level" => "%{[mdc][log_level]}" }
      }
      mutate {
        # 2. 대문자로 변환 (critical -> CRITICAL)
        uppercase => [ "log_level" ]
      }
    }

  # ======================================================
  # Security Log 처리
  # ======================================================
  if "sec_log" in [tags] {
    if [logger] { mutate { copy => { "logger" => "logger_name" } } }

    # 1. MDC의 log_level을 최우선으로 사용
    if [mdc][log_level] {
      mutate {
        replace => { "log_level" => "%{[mdc][log_level]}" }
        uppercase => [ "log_level" ]
      }
    }

    # 2. 기본값 설정
    if ![log_level] {
      mutate { add_field => { "log_level" => "INFO" } }
    }

    # 3. Threat Level 추출
    if [mdc][threat_level] {
      mutate {
        add_field => { "[security][threat_level]" => "%{[mdc][threat_level]}" }
        lowercase => [ "[security][threat_level]" ]
      }
    } else {
      mutate { add_field => { "[security][threat_level]" => "low" } }
    }

    # 4. Attack Type 추출
    if [mdc][attack_type] {
      mutate { add_field => { "[attack][type]" => "%{[mdc][attack_type]}" } }
    }

    # 5. Source IP 추출
    if [mdc][source_ip] {
      mutate { add_field => { "[client][ip]" => "%{[mdc][source_ip]}" } }
    }

    # 6. Blocked 필드 처리
    if [mdc][blocked] {
      if [mdc][blocked] == "true" {
        mutate { add_field => { "blocked" => true } }
      } else {
        mutate { add_field => { "blocked" => false } }
      }
    } else {
      mutate { add_field => { "blocked" => false } }
    }

    # 7. 메시지 기반 분석 (백업)
    if ![mdc][attack_type] and [message] {
      if [message] =~ /Bad credentials|password does not match|User not found|Authentication failed/ {
        ruby {
          code => '
            event.set("log_level", "WARN") unless event.get("log_level")
            event.set("[security][threat_level]", "medium")
            event.set("[attack][type]", "login_failure")
          '
        }
      } else if [message] =~ /Access is denied|AccessDeniedException/ {
        ruby {
          code => '
            event.set("log_level", "ERROR") unless event.get("log_level")
            event.set("[security][threat_level]", "high")
            event.set("[attack][type]", "access_denied")
          '
        }
      } else if [message] =~ /CSRF/ {
        ruby {
          code => '
            event.set("log_level", "CRITICAL") unless event.get("log_level")
            event.set("[security][threat_level]", "critical")
            event.set("[attack][type]", "csrf")
          '
        }
      }
    }

    # 8. 최종 검증: log_level이 없으면 threat_level 기반 매핑
    if ![log_level] or [log_level] == "" {
      if [security][threat_level] == "critical" {
        mutate { replace => { "log_level" => "CRITICAL" } }
      } else if [security][threat_level] == "high" {
        mutate { replace => { "log_level" => "ERROR" } }
      } else if [security][threat_level] == "medium" {
        mutate { replace => { "log_level" => "WARN" } }
      } else {
        mutate { replace => { "log_level" => "INFO" } }
      }
    }
  }

  # ======================================================
  # Database Log 처리
  # ======================================================
  if "db_log" in [tags] {
    if [logger] { mutate { copy => { "logger" => "logger_name" } } }

    # duration_ms 처리
    if [duration_ms] {
      mutate {
        add_field => { "[query][duration_ms]" => "%{duration_ms}" }
        remove_field => [ "duration_ms" ]
      }
      mutate {
        convert => { "[query][duration_ms]" => "integer" }
      }
    }

    # ERROR 레벨이면 에러 태그 추가
    if [log_level] == "ERROR" {
      mutate { add_tag => [ "db_error", "error_log" ] }
    }
  }

  # ======================================================
  # Audit Log 처리
  # ======================================================
  if "audit_log" in [tags] {
    ruby {
      code => '
        event.set("[event][action]", "general")
        event.set("[event][category]", "general")
        event.set("[event][result]", "success")
      '
    }

    if [message] =~ /registration|registered/ {
      ruby {
        code => '
          event.set("[event][action]", "user.registration")
          event.set("[event][category]", "authentication")
        '
      }
    } else if [message] =~ /login.*success/ {
      ruby {
        code => '
          event.set("[event][action]", "user.login")
          event.set("[event][category]", "authentication")
        '
      }
    } else if [message] =~ /login.*fail|authentication failed/ {
      ruby {
        code => '
          event.set("[event][action]", "user.login")
          event.set("[event][category]", "authentication")
          event.set("[event][result]", "failure")
        '
      }
    } else if [message] =~ /logout/ {
      ruby {
        code => '
          event.set("[event][action]", "user.logout")
          event.set("[event][category]", "authentication")
        '
      }
    }
  }

  # ======================================================
  # Error Log 정규화
  # ======================================================
  if "error_log" in [tags] {
    if [source] and [source][class] {
      mutate { add_field => { "logger_name" => "%{[source][class]}" } }
    }
  }

  # ======================================================
  # ✅ [최종 정규화] 모든 로그의 log_level을 대문자로 통일
  # ======================================================
  if [log_level] {
    mutate {
      uppercase => [ "log_level" ]
    }
  }

  # ======================================================
  # 불필요한 필드 제거
  # ======================================================
  mutate {
    remove_field => [ "log", "event.original", "host", "logLevel", "level" ]
  }
}

output {
  # 1. DB 에러 처리 (가장 먼저 체크)
  if "db_error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "database-logs-%{+YYYY.MM.dd}"
    }
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  }
  # 2. 일반 DB 로그
  else if "db_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "database-logs-%{+YYYY.MM.dd}"
    }
  }
  # 3. 일반 에러 로그
  else if "error_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  }
  # 4. 애플리케이션 로그
  else if "app_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "application-logs-%{+YYYY.MM.dd}"
    }
  }
  # 5. 접근 로그
  else if "access_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "access-logs-%{+YYYY.MM.dd}"
    }
  }
  # 6. 보안 로그
  else if "sec_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "security-logs-%{+YYYY.MM.dd}"
    }
  }
  # 7. 감사 로그
  else if "audit_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "audit-logs-%{+YYYY.MM.dd}"
    }
  }
  # 8. 성능 로그
  else if "perf_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "performance-metrics-%{+YYYY.MM.dd}"
    }
  }

  # 디버깅용 (개발 중에만 활성화)
  stdout { codec => rubydebug }
}