input {
  # 1. Application Log
  file {
    path => "/usr/share/logstash/pipeline/logs/application.log"
    start_position => "beginning"
    codec => json
    tags => ["app_log"]
  }

  # 2. Error Log
  file {
    path => "/usr/share/logstash/pipeline/logs/error.log"
    start_position => "beginning"
    codec => json
    tags => ["error_log"]
  }

  # 3. Access Log
  file {
    path => "/usr/share/logstash/pipeline/logs/access.log"
    start_position => "beginning"
    codec => json
    tags => ["access_log"]
  }

  # 4. Audit Log
  file {
    path => "/usr/share/logstash/pipeline/logs/audit.log"
    start_position => "beginning"
    codec => json
    tags => ["audit_log"]
  }

  # 5. Database Log
  file {
    path => "/usr/share/logstash/pipeline/logs/database.log"
    start_position => "beginning"
    codec => json
    tags => ["db_log"]
  }

  # 6. Security Log
  file {
    path => "/usr/share/logstash/pipeline/logs/security.log"
    start_position => "beginning"
    codec => json
    tags => ["sec_log"]
  }

  # 7. Performance Log
  file {
    path => "/usr/share/logstash/pipeline/logs/performance.log"
    start_position => "beginning"
    codec => json
    tags => ["perf_log"]
  }
}

filter {
  date {
    match => [ "@timestamp", "ISO8601" ]
    target => "@timestamp"
    timezone => "Asia/Seoul"
  }

  if "db_log" in [tags] {
    # logger 필드 정규화
    if [logger] {
      mutate { copy => { "logger" => "logger_name" } }
    }

    if [level] {
      mutate { copy => { "level" => "log_level" } }
    }

    # ✅ error 필드가 문자열로 들어온 경우 JSON 파싱
    if [error] and [error] =~ /^\{/ {
      json {
        source => "error"
        target => "error"
      }
    }

    # ✅ 예외 발생 시 message에 SQL 포함 여부 확인
    if [message] =~ /SQL Execution Failed/ {
      mutate {
        add_tag => [ "sql_error" ]
      }
    }
  }

  mutate {
    remove_field => [ "log", "event", "host" ]
  }
}

output {
  if "app_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "application-logs-%{+YYYY.MM.dd}"  # 날짜 패턴 추가
    }
  }

  else if "error_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  }

  else if "access_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "access-logs-%{+YYYY.MM.dd}"
    }
  }

  else if "audit_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "audit-logs-%{+YYYY.MM.dd}"
    }
  }

  else if "db_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "database-logs-%{+YYYY.MM.dd}"
    }
  }

  else if "sec_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "security-logs-%{+YYYY.MM.dd}"
    }
  }

  else if "perf_log" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch-service:9200"]
      index => "performance-metrics-%{+YYYY.MM.dd}"
    }
  }

  # 연결 성공 여부를 Logstash 로그로 확인하기 위해 켜둠
  stdout { codec => rubydebug }
}