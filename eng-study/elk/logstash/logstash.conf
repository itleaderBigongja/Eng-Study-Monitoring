# ======================================================
# 1. INPUT: 로그 파일 읽기 (JSON 형식)
# ======================================================
input {
  file { path => "/usr/share/logstash/pipeline/logs/application.log" start_position => "beginning" codec => json tags => ["app_log"] }
  file { path => "/usr/share/logstash/pipeline/logs/error.log"       start_position => "beginning" codec => json tags => ["error_log"] }
  file { path => "/usr/share/logstash/pipeline/logs/access.log"      start_position => "beginning" codec => json tags => ["access_log"] }
  file { path => "/usr/share/logstash/pipeline/logs/audit.log"       start_position => "beginning" codec => json tags => ["audit_log"] }
  file { path => "/usr/share/logstash/pipeline/logs/database.log"    start_position => "beginning" codec => json tags => ["db_log"] }
  file { path => "/usr/share/logstash/pipeline/logs/security.log"    start_position => "beginning" codec => json tags => ["sec_log"] }
  file { path => "/usr/share/logstash/pipeline/logs/performance.log" start_position => "beginning" codec => json tags => ["perf_log"] }
}

# ======================================================
# 2. FILTER: 데이터 정제 및 가공
# ======================================================
filter {
  # (1) 불필요한 로그 삭제
  if [message] =~ "kube-probe" or [user_agent] =~ "kube-probe" { drop { } }
  if [message] =~ "/actuator/health" or [message] =~ "/actuator/prometheus" { drop { } }
  if [message] =~ "\.(css|js|png|jpg|ico|woff|ttf)" { drop { } }

  # (2) 공통 데이터 표준화
  date {
    match => [ "@timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss.SSS", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
    target => "@timestamp"
    timezone => "Asia/Seoul"
  }

  # 필드명 표준화 (logLevel, level -> log_level)
  if [logLevel] { mutate { rename => { "logLevel" => "log_level" } } }
  if [level] { mutate { rename => { "level" => "log_level" } } }

  # ★ [방어 코드] 혹시 log_level이 없으면 INFO로 초기화 (ErrorLog 포맷 차이 방지)
  if ![log_level] { mutate { add_field => { "log_level" => "INFO" } } }

  # 대문자 변환
  if [log_level] { mutate { uppercase => [ "log_level" ] } }

  # ======================================================
  # (3) 로그별 상세 처리 (태그별 로직)
  # ======================================================

  # [Access Log] 400/500 에러 처리
  if "access_log" in [tags] {
    if [http][status_code] {
      mutate { convert => { "[http][status_code]" => "integer" } }
      if [http][status_code] >= 500 {
        mutate { replace => { "log_level" => "CRITICAL" } }
      } else if [http][status_code] >= 400 {
        mutate { replace => { "log_level" => "WARN" } }
      }
    }
  }

  # [Security Log] threat_level 체크
  if "sec_log" in [tags] {
    # 1. threat_level 찾기
    if ![security][threat_level] {
      if [mdc][threat_level] {
         mutate { add_field => { "[security][threat_level]" => "%{[mdc][threat_level]}" } }
      } else if [threat_level] {
         mutate { add_field => { "[security][threat_level]" => "%{threat_level}" } }
      } else {
         mutate { add_field => { "[security][threat_level]" => "low" } }
      }
    }

    # 소문자로 통일
    mutate { lowercase => [ "[security][threat_level]" ] }

    # 2. 레벨 변경 로직
    if [security][threat_level] == "critical" {
      mutate { replace => { "log_level" => "CRITICAL" } }
    } else if [security][threat_level] == "high" {
      mutate { replace => { "log_level" => "ERROR" } }
    } else if [security][threat_level] == "medium" {
      mutate { replace => { "log_level" => "WARN" } }
    }
  }

  # [Database Log] 슬로우 쿼리 및 에러 처리
  if "db_log" in [tags] {
    # 1. duration_ms 숫자 변환
    if [duration_ms] {
      mutate { convert => { "duration_ms" => "integer" } }
    }

    # 2. 실행 시간에 따른 레벨 승격 (Slow Query 감지)
    if [duration_ms] {
      if [duration_ms] >= 2000 {
        mutate { replace => { "log_level" => "ERROR" } }
        mutate { add_tag => [ "slow_query" ] }
      } else if [duration_ms] >= 1000 {
        mutate { replace => { "log_level" => "WARN" } }
        mutate { add_tag => [ "slow_query" ] }
      }
    }

    # 3. DB 에러 태그 추가 (전역 검색용)
    if [log_level] in ["ERROR", "CRITICAL", "FATAL"] {
      mutate { add_tag => [ "db_error", "error_log" ] }
    }
  }

  # [Audit Log]
  if "audit_log" in [tags] {
    ruby {
      code => '
        event.set("[event][action]", "general")
        event.set("[event][result]", "success")
        msg = event.get("message")
        if msg
          if msg.include?("login") && msg.include?("success")
            event.set("[event][action]", "user.login")
            event.set("[event][category]", "authentication")
          elsif msg.include?("fail") || msg.include?("Authentication failed")
            event.set("[event][action]", "user.login")
            event.set("[event][result]", "failure")
          elsif msg.include?("logout")
            event.set("[event][action]", "user.logout")
          elsif msg.include?("register") || msg.include?("registration")
             event.set("[event][action]", "user.registration")
          end
        end
      '
    }
  }

  # ======================================================
  # (4) ★ [핵심 변경] 전역 레벨 승격 (Global Level Promotion)
  # 파일 종류(태그)와 상관없이 메시지가 심각하면 무조건 CRITICAL
  # ======================================================

  if [message] =~ /OutOfMemory|StackOverflow|Fatal|Critical|Connection refused|Deadlock|Connection timed out|Too many connections/ {
    mutate { replace => { "log_level" => "CRITICAL" } }
  }

  # (5) 마무리
  mutate {
    remove_field => [ "timestamp", "path", "host", "@version", "thread_name", "log", "event.original" ]
  }
}

# ======================================================
# 3. OUTPUT: Elasticsearch로 전송
# ======================================================
output {
  # 1. 심각한 DB 에러 (DB로그 + 에러로그 양쪽에 저장)
  if "db_error" in [tags] {
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "database-logs-%{+YYYY.MM.dd}" }
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "error-logs-%{+YYYY.MM.dd}" }
  }
  # 2. Security Log
  else if "sec_log" in [tags] {
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "security-logs-%{+YYYY.MM.dd}" }
  }
  # 3. Application Log
  else if "app_log" in [tags] {
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "application-logs-%{+YYYY.MM.dd}" }
  }
  # 4. Error Log
  else if "error_log" in [tags] {
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "error-logs-%{+YYYY.MM.dd}" }
  }
  # 5. Database Log (일반)
  else if "db_log" in [tags] {
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "database-logs-%{+YYYY.MM.dd}" }
  }
  # 6. Audit Log
  else if "audit_log" in [tags] {
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "audit-logs-%{+YYYY.MM.dd}" }
  }
  # 7. Access Log
  else if "access_log" in [tags] {
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "access-logs-%{+YYYY.MM.dd}" }
  }
  # 8. Performance Log
  else if "perf_log" in [tags] {
    elasticsearch { hosts => ["elasticsearch-service:9200"] index => "performance-metrics-%{+YYYY.MM.dd}" }
  }
}